---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
spec:
  values:
    defaultRules:
      additionalRuleLabels:
        cluster: doks-dev
      ingress:
        hosts:
        - alertmanager.mattera.io
      alertmanagerSpec:
        externalUrl: https://alertmanager.mattera.io
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: do-block-storage
    # working
    alertmanager:
      enabled: false ## TURN OFF
      serviceMonitor:
        relabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
    # not working
    grafana:
      serviceMonitor:
        relabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
    kubelet:
      serviceMonitor:
        # working @ /metrics
        relabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
        # not working @ /metrics/cadvisor
        cAdvisorRelabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
        probesRelabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
        resourceRelabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
    # working
    coreDns:
      serviceMonitor:
        relabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
    # working
    kube-state-metrics:
      prometheus:
        monitor:
          relabelings:
          # upstream
          - action: replace
            sourceLabels: [__metrics_path__]
            targetLabel: metrics_path
          # custom
          - targetLabel: cluster
            replacement: doks-dev
            sourceLabels: [__address__]
    # working
    prometheus-node-exporter:
      prometheus:
        monitor:
          relabelings:
          # upstream
          - action: replace
            sourceLabels: [__metrics_path__]
            targetLabel: metrics_path
          # custom
          - targetLabel: cluster
            replacement: doks-dev
            sourceLabels: [__address__]
    # working
    prometheusOperator:
      serviceMonitor:
        relabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
    # working
    prometheus:
      enabled: false ## TURN OFF
      serviceMonitor:
        relabelings:
        # upstream
        - action: replace
          sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        # custom
        - targetLabel: cluster
          replacement: doks-dev
          sourceLabels: [__address__]
      ingress:
        hosts:
        - prometheus.mattera.io
      prometheusSpec:
        externalUrl: https://prometheus.mattera.io
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: do-block-storage
